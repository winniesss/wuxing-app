// å°å…­å£¬å åœå·¥å…·

// å°å…­å£¬å…­ä¸ªä½ç½®
const XIAOLIUREN_POSITIONS = [
  { name: 'å¤§å®‰', meaning: 'å¤§å‰', description: 'èº«æœªåŠ¨æ—¶ï¼Œå±æœ¨é’é¾™ï¼Œä¸»ä¸€äº”ä¸ƒï¼Œå‡¡äº‹å¤§å‰ï¼Œæ±‚è°‹ä¸€äº”ä¸ƒæ•°' },
  { name: 'ç•™è¿', meaning: 'å‡¶', description: 'å’æœªå½’æ—¶ï¼Œå±æ°´ç„æ­¦ï¼Œä¸»äºŒå…«åï¼Œå’æœªå½’æ—¶ï¼Œæ±‚è°‹äºŒå…«åæ•°' },
  { name: 'é€Ÿå–œ', meaning: 'å‰', description: 'äººä¾¿è‡³æ—¶ï¼Œå±ç«æœ±é›€ï¼Œä¸»ä¸‰å…­ä¹ï¼Œäººä¾¿è‡³æ—¶ï¼Œæ±‚è°‹ä¸‰å…­ä¹æ•°' },
  { name: 'èµ¤å£', meaning: 'å‡¶', description: 'å®˜äº‹å‡¶æ—¶ï¼Œå±é‡‘ç™½è™ï¼Œä¸»å››ä¸ƒåï¼Œå®˜äº‹å‡¶æ—¶ï¼Œæ±‚è°‹å››ä¸ƒåæ•°' },
  { name: 'å°å‰', meaning: 'å¤§å‰', description: 'äººæ¥å–œæ—¶ï¼Œå±æœ¨å…­åˆï¼Œä¸»ä¸€äº”ä¸ƒï¼Œäººæ¥å–œæ—¶ï¼Œæ±‚è°‹ä¸€äº”ä¸ƒæ•°' },
  { name: 'ç©ºäº¡', meaning: 'å¤§å‡¶', description: 'éŸ³ä¿¡ç¨€æ—¶ï¼Œå±åœŸå‹¾é™ˆï¼Œä¸»ä¸‰å…­ä¹ï¼ŒéŸ³ä¿¡ç¨€æ—¶ï¼Œæ±‚è°‹ä¸‰å…­ä¹æ•°' }
];

// æ ¹æ®3ä¸ªæ•°å­—è¿›è¡Œå°å…­å£¬å åœ
export function calculateXiaoLiuRen(num1, num2, num3) {
  // ç¡®ä¿æ•°å­—åœ¨1-6èŒƒå›´å†…
  const n1 = ((num1 - 1) % 6) + 1;
  const n2 = ((num2 - 1) % 6) + 1;
  const n3 = ((num3 - 1) % 6) + 1;
  
  // ä»å¤§å®‰ï¼ˆç´¢å¼•0ï¼‰å¼€å§‹ï¼ŒæŒ‰æ•°å­—ç§»åŠ¨
  let position = 0; // èµ·å§‹ä½ç½®ï¼šå¤§å®‰
  
  // ç¬¬ä¸€ä¸ªæ•°å­—ï¼šä»å¤§å®‰å¼€å§‹ï¼Œé¡ºæ—¶é’ˆæ•°
  position = (position + n1 - 1) % 6;
  
  // ç¬¬äºŒä¸ªæ•°å­—ï¼šä»å½“å‰ä½ç½®å¼€å§‹ï¼Œé¡ºæ—¶é’ˆæ•°
  position = (position + n2 - 1) % 6;
  
  // ç¬¬ä¸‰ä¸ªæ•°å­—ï¼šä»å½“å‰ä½ç½®å¼€å§‹ï¼Œé¡ºæ—¶é’ˆæ•°
  position = (position + n3 - 1) % 6;
  
  return {
    position: position,
    result: XIAOLIUREN_POSITIONS[position],
    numbers: [n1, n2, n3]
  };
}

// æ ¹æ®ç”¨æˆ·å…«å­—å’Œæ•°å­—ç”Ÿæˆå åœç»“æœ
export function generateXiaoLiuRenResult(num1, num2, num3, userBazi) {
  const result = calculateXiaoLiuRen(num1, num2, num3);
  const { name, meaning, description } = result.result;
  
  // æ ¹æ®ç”¨æˆ·å…«å­—å’Œç»“æœç”Ÿæˆä¸ªæ€§åŒ–è§£è¯»
  let interpretation = '';
  
  if (userBazi && userBazi.dayStem) {
    // éœ€è¦å¯¼å…¥getElementå‡½æ•°ï¼Œä½†ä¸ºäº†é¿å…å¾ªç¯ä¾èµ–ï¼Œè¿™é‡Œç®€åŒ–å¤„ç†
    const ganWuxing = {
      'ç”²': 'æœ¨', 'ä¹™': 'æœ¨',
      'ä¸™': 'ç«', 'ä¸': 'ç«',
      'æˆŠ': 'åœŸ', 'å·±': 'åœŸ',
      'åºš': 'é‡‘', 'è¾›': 'é‡‘',
      'å£¬': 'æ°´', 'ç™¸': 'æ°´'
    };
    const userElement = ganWuxing[userBazi.dayStem] || 'æœ¨';
    interpretation = `ğŸ“… ä½ çš„å…«å­—ï¼šæ—¥ä¸»${userBazi.dayStem}ï¼ˆ${userElement}ï¼‰\n\nğŸ”® å°å…­å£¬å åœç»“æœï¼š`;
  } else {
    interpretation = 'ğŸ”® å°å…­å£¬å åœç»“æœï¼š';
  }
  
  // æ ¹æ®ç»“æœç»™å‡ºé€šç”¨å»ºè®®ï¼ˆæ¶µç›–ç”Ÿæ´»ã€å·¥ä½œã€æ„Ÿæƒ…ã€å¥åº·ã€è´¢è¿ç­‰ï¼‰
  let advice = '';
  const positionName = name;
  
  // æ ¹æ®å…·ä½“ä½ç½®ç»™å‡ºæ›´è¯¦ç»†çš„å»ºè®®
  if (positionName === 'å¤§å®‰') {
    advice = 'âœ¨ æ­¤å¦å¤§å‰ï¼Œä¸‡äº‹é¡ºé‚ã€‚\n\nâ€¢ äº‹ä¸šï¼šé€‚åˆå¼€å±•æ–°é¡¹ç›®ï¼ŒæŠŠæ¡è‰¯æœº\nâ€¢ æ„Ÿæƒ…ï¼šå…³ç³»å’Œè°ï¼Œé€‚åˆè¡¨è¾¾å¿ƒæ„\nâ€¢ è´¢è¿ï¼šæ­£è´¢ç¨³å®šï¼Œå¯è€ƒè™‘æŠ•èµ„\nâ€¢ å¥åº·ï¼šèº«ä½“åº·å¥ï¼Œæ³¨æ„ä¼‘æ¯\nâ€¢ å‡ºè¡Œï¼šå¹³å®‰é¡ºåˆ©ï¼Œå®œå‡ºè¡Œ';
  } else if (positionName === 'ç•™è¿') {
    advice = 'âš ï¸ æ­¤å¦ä¸ºå‡¶ï¼Œéœ€è°¨æ…è¡Œäº‹ã€‚\n\nâ€¢ äº‹ä¸šï¼šè¿›å±•ç¼“æ…¢ï¼Œéœ€è€å¿ƒç­‰å¾…\nâ€¢ æ„Ÿæƒ…ï¼šå¯èƒ½æœ‰æ³¢æŠ˜ï¼Œå¤šæ²Ÿé€šç†è§£\nâ€¢ è´¢è¿ï¼šè´¢è¿ä¸€èˆ¬ï¼Œé¿å…å¤§é¢æŠ•èµ„\nâ€¢ å¥åº·ï¼šæ³¨æ„èº«ä½“ï¼Œé¿å…è¿‡åº¦åŠ³ç´¯\nâ€¢ å‡ºè¡Œï¼šå¯èƒ½å»¶è¯¯ï¼Œæå‰å‡†å¤‡';
  } else if (positionName === 'é€Ÿå–œ') {
    advice = 'ğŸ‰ æ­¤å¦ä¸ºå‰ï¼Œå–œäº‹å°†è‡³ã€‚\n\nâ€¢ äº‹ä¸šï¼šè¿›å±•è¿…é€Ÿï¼Œé€‚åˆä¸»åŠ¨å‡ºå‡»\nâ€¢ æ„Ÿæƒ…ï¼šå…³ç³»å‡æ¸©ï¼Œé€‚åˆè¡¨ç™½æˆ–æ±‚å©š\nâ€¢ è´¢è¿ï¼šåè´¢è¾ƒæ—ºï¼Œå¯æŠŠæ¡æœºä¼š\nâ€¢ å¥åº·ï¼šèº«ä½“è‰¯å¥½ï¼Œé€‚åˆè¿åŠ¨\nâ€¢ å‡ºè¡Œï¼šå‡ºè¡Œé¡ºåˆ©ï¼Œé€‚åˆè¿œè¡Œ';
  } else if (positionName === 'èµ¤å£') {
    advice = 'âš ï¸ æ­¤å¦ä¸ºå‡¶ï¼Œå£èˆŒæ˜¯éã€‚\n\nâ€¢ äº‹ä¸šï¼šå¯èƒ½é‡åˆ°é˜»ç¢ï¼Œéœ€è°¨æ…å¤„ç†\nâ€¢ æ„Ÿæƒ…ï¼šæ˜“æœ‰äº‰æ‰§ï¼Œå¤šåŒ…å®¹ç†è§£\nâ€¢ è´¢è¿ï¼šè´¢è¿ä¸ä½³ï¼Œé¿å…å†²åŠ¨æ¶ˆè´¹\nâ€¢ å¥åº·ï¼šæ³¨æ„å£èˆŒã€å‘¼å¸ç³»ç»Ÿ\nâ€¢ å‡ºè¡Œï¼šå¯èƒ½ä¸é¡ºï¼Œæ³¨æ„å®‰å…¨';
  } else if (positionName === 'å°å‰') {
    advice = 'âœ¨ æ­¤å¦å¤§å‰ï¼Œå°æœ‰æ”¶è·ã€‚\n\nâ€¢ äº‹ä¸šï¼šç¨³æ­¥å‘å±•ï¼Œé€‚åˆåˆä½œ\nâ€¢ æ„Ÿæƒ…ï¼šå…³ç³»èæ´½ï¼Œé€‚åˆçº¦ä¼š\nâ€¢ è´¢è¿ï¼šå°æœ‰è¿›è´¦ï¼Œé€‚åˆå‚¨è“„\nâ€¢ å¥åº·ï¼šèº«ä½“è‰¯å¥½ï¼Œä¿æŒè§„å¾‹ä½œæ¯\nâ€¢ å‡ºè¡Œï¼šå‡ºè¡Œé¡ºåˆ©ï¼Œé€‚åˆçŸ­é€”';
  } else if (positionName === 'ç©ºäº¡') {
    advice = 'âŒ æ­¤å¦å¤§å‡¶ï¼Œå®œé™ä¸å®œåŠ¨ã€‚\n\nâ€¢ äº‹ä¸šï¼šè¿›å±•ä¸é¡ºï¼Œå®œç­‰å¾…æ—¶æœº\nâ€¢ æ„Ÿæƒ…ï¼šå¯èƒ½å†·æ·¡ï¼Œå¤šå…³å¿ƒå¯¹æ–¹\nâ€¢ è´¢è¿ï¼šè´¢è¿ä¸ä½³ï¼Œé¿å…æŠ•èµ„\nâ€¢ å¥åº·ï¼šæ³¨æ„èº«ä½“ï¼Œå¤šä¼‘æ¯\nâ€¢ å‡ºè¡Œï¼šä¸å®œå‡ºè¡Œï¼Œæ˜“æœ‰æ„å¤–';
  }
  
  return {
    ...result,
    interpretation,
    advice,
    fullText: `${interpretation}\n\nã€${name}ã€‘${meaning}\n\n${description}\n\n${advice}\n\nğŸ’¡ æç¤ºï¼šä»¥ä¸Šå»ºè®®ä»…ä¾›å‚è€ƒï¼Œå…·ä½“è¡ŒåŠ¨è¿˜éœ€ç»“åˆå®é™…æƒ…å†µã€‚`
  };
}

// ä»æ–‡æœ¬ä¸­æå–3ä¸ªæ•°å­—
export function extractThreeNumbers(text) {
  // åŒ¹é…æ•°å­—ï¼ŒåŒ…æ‹¬ä¸­æ–‡æ•°å­—
  const numberMap = {
    'ä¸€': 1, 'äºŒ': 2, 'ä¸‰': 3, 'å››': 4, 'äº”': 5, 'å…­': 6,
    'ä¸ƒ': 7, 'å…«': 8, 'ä¹': 9, 'å': 10,
    '1': 1, '2': 2, '3': 3, '4': 4, '5': 5, '6': 6,
    '7': 7, '8': 8, '9': 9, '10': 10
  };
  
  // æå–æ‰€æœ‰æ•°å­—
  const numbers = [];
  const regex = /[ä¸€äºŒä¸‰å››äº”å…­ä¸ƒå…«ä¹å\d]/g;
  let match;
  
  while ((match = regex.exec(text)) !== null) {
    const num = numberMap[match[0]] || parseInt(match[0]);
    if (num && num >= 1 && num <= 10) {
      numbers.push(num);
    }
  }
  
  // å¦‚æœæ‰¾åˆ°3ä¸ªæˆ–æ›´å¤šæ•°å­—ï¼Œè¿”å›å‰3ä¸ª
  if (numbers.length >= 3) {
    return numbers.slice(0, 3);
  }
  
  return null;
}

